# Сервер с бородой: Write-up

Нам дан очень большой системный лог. Насколько большой? Можем оценить по количеству упоминаемых месяцев:

```bash
$ zcat syslog.gz | awk '{print $1}' | uniq | nl
     1  Dec
     2  Jan
     3  Feb
     4  Mar
...
   315  Feb
   316  Mar
```

Получается, лог вёлся 26 с лишним лет. Можно даже выяснить, какие именно это были годы, по событиям синхронизации времени — и привязать это к конкретным строкам:

```bash
$ zcat syslog.gz | nl | grep ntpd
1210890 Aug 26 18:35:19 localhost ntpd[31564]: time reset by step to 2016-08-26 18:35:19 (offset -0.163922 sec)
1240862 Feb 01 01:43:11 localhost ntpd[36879]: time reset by step to 2017-02-01 01:43:11 (offset -0.012117 sec)
...
1769707 Oct 20 14:21:03 localhost ntpd[36510]: time reset by step to 2024-10-20 14:21:03 (offset 0.302372 sec)
1780358 Dec 16 07:15:06 localhost ntpd[15008]: time reset by step to 2024-12-16 07:15:06 (offset -0.359451 sec)
```

Отсчитывая назад, можем заключить, что первые строки относятся к 1998 году.

Можно заметить, что события в логе происходят достаточно часто: обязательно несколько штук в час. При этом системный лог ведётся в местном времени (вернее, в том времени, которое выбрано в настройках сервера — и зачастую это именно местное время, если не предпринято специальных усилий). Местное время в некоторых частях планеты бывает летнее и зимнее; кроме того, правила перехода между летним и зимним временем, а также сам часовой пояс могут меняться по решению местных властей.

Попробуем найти в логе все временны́е аномалии — прыжки назад, а также вперёд более чем на час:

```python
import gzip, datetime

current_year = 1998
prev_month = "Dec"
prev_timestamp = None

for line in gzip.open("syslog.gz", "rt"):
    month = line[:3]
    if prev_month == "Dec" and month == "Jan":
        current_year += 1
    prev_month = month

    timestamp = datetime.datetime.strptime(f"{current_year} {line[:14]}", "%Y %b %d %H:%M:%S")

    if prev_timestamp:
        diff = (timestamp - prev_timestamp).total_seconds()
        if diff < 0 or diff > 3600:
            print(f"{prev_timestamp} - {timestamp}")
    prev_timestamp = timestamp
```

Найдутся вот такие сдвиги:

```
2004-05-31 23:51:05 - 2004-05-31 23:00:05
2004-06-12 23:52:02 - 2004-06-13 01:06:01
2007-12-29 23:53:04 - 2007-12-30 01:02:03
2008-03-15 23:54:03 - 2008-03-15 23:01:05
2008-10-18 23:54:00 - 2008-10-19 01:07:02
2009-03-14 23:46:05 - 2009-03-14 23:01:04
```

Существует база данных [tzdata](https://data.iana.org/time-zones/tz-link.html), содержащая информацию обо всех правилах исчисления времени, включая исторические изменения.

Переключение часового пояса два раза за менее чем две недели (в 2004) — явно не регулярное событие, и оно там должно быть отражено. Поискав в текстовых файлах базы даты, похожие на наши, находим, что 13 июня 2004 [упоминается только один раз](https://github.com/eggert/tz/blob/main/southamerica#L446):

```
# Tucumán (TM)
Zone America/Argentina/Tucuman -4:20:52 - LMT	1894 Oct 31
		#STDOFF	-4:16:48.25
			-4:16:48 -	CMT	1920 May
			-4:00	-	%z	1930 Dec
			-4:00	Arg	%z	1969 Oct  5
			-3:00	Arg	%z	1991 Mar  3
			-4:00	-	%z	1991 Oct 20
			-3:00	Arg	%z	1999 Oct  3
			-4:00	Arg	%z	2000 Mar  3
			-3:00	-	%z	2004 Jun  1
			-4:00	-	%z	2004 Jun 13
			-3:00	Arg	%z
```

[И действительно](https://en.wikipedia.org/wiki/Time_in_Argentina), в Аргентине самые странные правила перехода на летнее время: решение о том, переходить ли на другое время, принимается каждый раз, причём отдельные провинции могут принимать решение самостоятельно. В 2004 разные провинции действительно принимали решение в разное время, итогом чего стал [сущий кошмар](https://statoids.com/tar.html).

Так или иначе, компьютер, породивший данный лог, мог находиться только в провинции Тукуман.

Технологический университет в этой провинции единственный: это филиал Национального Технологического _(Facultad Regional Tucumán de la Universidad Tecnológica Nacional)_. Его легко [найти на картах](https://www.google.com/maps/place/Utn+Frt/@-26.8170952,-65.2011082,17z/) и ввести ответ: _-26.8170836, -65.1986317_.

С сайта нам радостно машут [флагом Аргентины](https://commons.wikimedia.org/wiki/File:Fiesta_popular_en_Colalao_del_Valle_Tucum%C3%A1n.JPG).

Флаг: **ugra_federation_is_so_federative_k2ppnixvfho7**

<!-- Бонус: [карта всех попыток сдать задание](). -->
