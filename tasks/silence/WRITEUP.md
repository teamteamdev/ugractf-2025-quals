# тишина: Write-up

Посмотрим, почему так тихо. Подключаемся:

```shell
$ nc q.2025.ugractf.ru 3252
```

...и видим ровным счётом ничего. [Темнарик](https://github.com/teamteamdev/ugractf-2024-quals/blob/master/tasks/inthedark) 2.0 какой-то, только совсем ничего не происходит. Точно ли не происходит? Давайте посмотрим, не присылает ли сервер всё же какие-то байты:

```shell
$ nc q.2025.ugractf.ru 3252 | xxd
00000000: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000100: 0000 0000 0000 0000 0000 0000 0000 0000  ................
...
```

Присылает, причём не сразу все, а как будто бы с непостоянной скоростью и какой-то задержкой. Давайте посмотрим в Wireshark, какие конкретно пакеты нам приходят:

![Wireshark](writeup/wireshark.png)

Какие интересные разные длины. Выпишем на длины именно содержимого пакетов: `69, 110, 116, 101, 114, 32, 116, 111, 107, 101, 110, 58, 32`. `32` намекает на ASCII, проверим:

```python
>>> bytes([69, 110, 116, 101, 114, 32, 116, 111, 107, 101, 110, 58, 32])
b'Enter token: '
```

Отлично, сервер ждёт от нас токен! Но если отправить токен обычным текстом, то ничего не происходит. Видимо, с сервером нужно поговорить на том же протоколе:

```python
import socket, sys, time

sock = socket.create_connection(("q.2025.ugractf.ru", 3252))

# Пропускаем фразу 'Enter token: '
for _ in range(13):
    sys.stdout.buffer.write(bytes([len(sock.recv(4096))]))
    sys.stdout.buffer.flush()

# Отправляем символы токена и \n по одному
for c in b"qw8molqggnxuiamz\n":
    sock.send(b"\x00" * c)
    time.sleep(0.1)

# Читаем ответ
while data := sock.recv(4096):
    sys.stdout.buffer.write(bytes([len(data)]))
    sys.stdout.buffer.flush()
```

Стандартная ошибка — забыть `time.sleep(0.1)`, из-за чего все пакеты склеются в один на стороне клиента, и сервер не сможет их разобрать. (Напомним, что TCP не гарантирует, что границы между пакетами сохраняются.)

Видим вывод:

```
Enter token: $ 
```

`$` звучит как промпт какого-то шелла. Перепишем солвер, добавив интерактивность:

```python
import socket, sys, time

sock = socket.create_connection(("q.2025.ugractf.ru", 3252))
sock.settimeout(1)

while True:
    # Считываем, пока считывается
    try:
        while True:
            data = sock.recv(4096)
            if not data:
                sys.exit(0)
            sys.stdout.buffer.write(bytes([len(data)]))
            sys.stdout.buffer.flush()
    except TimeoutError:
        pass

    # Отправляем ввод
    for c in (input() + "\n").encode():
        sock.send(b"\x00" * c)
        time.sleep(0.1)
```

Медленно, а что вы хотели?

```
Enter token: qw8molqggnxuiamz
$ ls
bin
dev
etc
flag.txt
home
lib
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
$ cat /flag.txt
ugra_can_you_hear_me_i_am_in_the_basement_rbs035w0x9ry9tmyaehxmb6p$ 
```

Флаг: **ugra_can_you_hear_me_i_am_in_the_basement_rbs035w0x9ry9tmyaehxmb6p**

## Постмортем

В начале соревнования таск не работал, и сервер действительно молчал, не присылая даже нулевые байты. Дело в буфферизации nginx, который добавили как прокси в последний момент и не заметили, что из-за него задание сломалось. Более того, похожий таск [уже был](https://github.com/teamteamdev/ugractf-2020-quals/blob/master/tasks/devzero/WRITEUP.md), и там была такая же ошибка.

## Интересные факты

В первой версии райтапа использовались более «кустарные» механизмы анализа трафика — [`ncat`](https://nmap.org/ncat) с флагом [`-x`](https://man.archlinux.org/man/ncat.1#OUTPUT_OPTIONS), парочка пайпов и `xxd` вместо wireshark и Python.

```shell
$ ncat -v -x dump q.2025.ugractf.ru 3252
Ncat: Version 7.95 ( https://nmap.org/ncat )
Ncat: Connected to 135.181.93.68:3252.
^C
$ # ^ подождали некоторое время, и увидели ту же пустоту
$ # Анализируем полученные пакеты
$ wc -l dump
79 dump
$ head -20 dump
0000   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0010   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0020   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0030   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0040   00 00 00 00 00                                    .....           
0000   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0010   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0020   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0030   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0040   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0050   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0060   00 00 00 00 00 00 00 00  00 00 00 00 00 00        ..............  
0000   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0010   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0020   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0030   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0040   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0050   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0060   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0070   00 00 00 00                                       ....            
$ # Можно посмотреть какой длины каждый пакет:
$ # взять каждую строку перед строками, начинающимися с `0000  `, а так же последнюю.
$ # Этот пайп опирается на то, что пакетов длины <= 16 байт не было, но в этом легко удостовериться:
$ # достаточно просто запускать не весь пайп сразу, а по частям
$ grep '^0000' dump -B1 | grep -v '^0000' | grep -v -; tail -1 dump
0040   00 00 00 00 00                                    .....           
0060   00 00 00 00 00 00 00 00  00 00 00 00 00 00        ..............  
0070   00 00 00 00                                       ....            
0060   00 00 00 00 00                                    .....           
0070   00 00                                             ..              
0010   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
0070   00 00 00 00                                       ....            
0060   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00     ............... 
0060   00 00 00 00 00 00 00 00  00 00 00                 ...........     
0060   00 00 00 00 00                                    .....           
0060   00 00 00 00 00 00 00 00  00 00 00 00 00 00        ..............  
0030   00 00 00 00 00 00 00 00  00 00                    ..........      
0010   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
$ # Длины пакетов -- `45 9e 74 65 72 20 74 6f 6b 65 6e 3a 20`.
$ # Проинтерпретируем как ASCII-текст:
$ <<<'45 6e 74 65 72 20 74 6f 6b 65 6e 3a 20' xxd -r -p | hexdump -C
00000000  45 6e 74 65 72 20 74 6f  6b 65 6e 3a 20           |Enter token: |
0000000d
```

Авторское [решение](./solve.rs), как и [сервер](./controller), написаны на Rust:

```shell
$ ADDRESS=q.2025.ugractf.ru:3252 ./solve.rs
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.18s
     Running `/home/yuki/.local/share/cargo/target/62/6b952374314774/debug/solve`
Setting up reverse shell...
Enter token: qw8molqggnxuiamz
$ cat /flag*; echo
ugra_can_you_hear_i_am_in_the_basement_rbs035w0x9ry9tmyaehxmb6p
$
```
